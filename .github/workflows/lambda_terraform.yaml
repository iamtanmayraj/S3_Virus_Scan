name: 'Terraform Deploy'

on:
  workflow_dispatch:
    inputs:
      terraform_action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'plan'
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-1'
      s3_bucket_name:
        description: 'S3 Bucket Name to scan'
        required: true
        type: string
      auto_approve:
        description: 'Auto-approve apply/destroy (use with caution)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  terraform:
    name: 'Terraform ${{ inputs.terraform_action }}'
    runs-on: ubuntu-latest
    environment: production

    steps:
      # Checkout the repository
      - name: Checkout
        uses: actions/checkout@v4

      # Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      # Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      # Terraform Format Check
      - name: Terraform Format Check
        id: fmt
        run: |
          set +e  # Temporarily disable exit on error to capture exit code
          terraform fmt -check -recursive
          FORMAT_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "‚úì Terraform formatting is valid"
          else
            echo "::error::Terraform files need formatting"
            echo "‚ùå Some Terraform files are not properly formatted."
            echo "To fix locally, run: terraform fmt -recursive"
          fi
        continue-on-error: true

      # Terraform Init
      - name: Terraform Init
        run: terraform init -input=false

      # Terraform Validate
      - name: Terraform Validate
        run: terraform validate -no-color

      # Terraform Plan
      - name: Terraform Plan
        if: inputs.terraform_action == 'plan' || inputs.terraform_action == 'apply'
        run: |
          terraform plan \
            -var="aws_region=${{ inputs.aws_region }}" \
            -var="s3_bucket_name=${{ inputs.s3_bucket_name }}" \
            -out=tfplan \
            -no-color
        continue-on-error: true

      # Save Terraform Plan
      - name: Save Terraform Plan
        if: inputs.terraform_action == 'plan' || inputs.terraform_action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan
          retention-days: 5

      # Terraform Apply
      - name: Terraform Apply
        if: inputs.terraform_action == 'apply' && (inputs.auto_approve == true || github.event_name == 'workflow_dispatch')
        run: |
          terraform apply \
            -var="aws_region=${{ inputs.aws_region }}" \
            -var="s3_bucket_name=${{ inputs.s3_bucket_name }}" \
            -auto-approve \
            -no-color

      # Terraform Destroy
      - name: Terraform Destroy
        if: inputs.terraform_action == 'destroy' && inputs.auto_approve == true
        run: |
          terraform destroy \
            -var="aws_region=${{ inputs.aws_region }}" \
            -var="s3_bucket_name=${{ inputs.s3_bucket_name }}" \
            -auto-approve \
            -no-color

      # Output Terraform outputs
      - name: Terraform Output
        if: inputs.terraform_action == 'apply'
        run: terraform output -json
        continue-on-error: true

      # Comment on PR (if applicable)
      - name: Comment PR
        if: inputs.terraform_action == 'plan' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
            
            *Pusher: @${{ github.actor }}, Action: \`${{ inputs.terraform_action }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
